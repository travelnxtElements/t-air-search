<link rel='import' href='../polymer/polymer.html'>
<link rel='import' href='../t-form/t-form.html'>
<!--
t-air-search is an UI component to capture below flight search criteria. It supports both one way and round trip searches but no multi city search. Upon search button click it validates criteria and fires a search event `t-air-search` which can be captured and pass on to API component to initiate a search. 

__UI search criteria object model passed in `t-air-search` event arguments__

    {    
        adultCount: Number, //default: 1
        childCount: Number, //default: 0
        infantCount: Number,//default: 0
        cabinType: String, // Economy/Business/First, //default: Economy        
        leg1Origin: Location Object, //default: null  //required field     
        leg1Destination: Location Object, //default: null //required field
        leg1Date: String, //as per globalization format, //default: null  //required field     
        leg2Date: String, //as per globalization format, //default: null  //required field
        tripType: String, //RoundTrip/OneWay, //default: RoundTrip
    }
 
__Location object model__

    {
        type: String, //Airport/City, 
        geoCode: String, //{Lat,Long} 
        name: String, 
        code: String, 
        cityName: String, 
        countryCode: String, 
        countryName: String, 
        formattedAddress: String, 
        id: Number, 
        stateCode: String, 
        stateName: String
    }   

__Example with API component__

    <t-air-search id="searchView" suggestion-url="{{API Full Url}}" query-params="token={{Auth Token}}"></t-air-search>

    <t-air-search-api id="searchApi" loading={{loading}}></t-air-search-api>
    <iron-meta key="Eva.contextName" value="testcontext" type="globals"></iron-meta>    
    <iron-meta key="Eva.apiBaseUrl" value="somedomain.com" type="globals"></iron-meta>

Note: API call in-progress and error states are not handled in this view component, so handle explicitly outside of it.
-->


<dom-module id='t-air-search'>
    <template>
        <style>
            :host {
                display: block;
                padding: 0 10px 5px;
            }
            
            t-form {
                padding: 0;
                margin: 0;
                max-width: 100%;
            }
            
            [pill-button]::content iron-selector {
                width: 100%;
                text-align: center;
            }
            
            ::content t-radio-button {
                -ms-flex: 1;
                -webkit-flex: 1;
                flex: 1;
            }
            
            t-autosuggest,
            t-calendar,
            t-stepper {
                outline: 0;
            }
        </style>
        <t-form id="searchForm" show-loader error-block class="canvas vertical layout flex" name="untitled-form" heading="Untitled Form" action-button="Full" submit-button-label="Search Flights" secondary-action-label="Cancel" label-position="Top" on-on-form-submit="_onSearch">
            <div class="form flex ">
                <div class="horizontal flex layout" style="position: relative;">
                    <div class="flex fieldset" data-category="formComponents">
                        <t-radio-group id="tripType" name="tripType" data='["RoundTrip","OneWay"]' pill-button selected-item="{{tripType}}">
                        </t-radio-group>
                    </div>
                </div>
                <div class="horizontal flex layout  grouped" style="position: relative;">
                    <div class="flex fieldset " data-category="formComponents">
                        <t-autosuggest id="leg1Origin" name="leg1Origin" required selected-item="{{leg1Origin}}" query-params="{{queryParams}}" sub-type="airport" class="center-justified" label="Origin" token-param="formattedAddress" data-url="{{suggestionUrl}}" on-autosuggest-select="_validateDestinations" on-blur="_validateDestinations" error-message="You missed this."></t-autosuggest>
                    </div>
                </div>
                <div class="horizontal flex layout  grouped" style="position: relative;">
                    <div class="flex fieldset " data-category="formComponents">
                        <t-autosuggest id="leg1Destination" name="leg1Destination" selected-item="{{leg1Destination}}" query-params="{{queryParams}}" sub-type="airport" required label="Destination" token-param="formattedAddress" data-url="{{suggestionUrl}}" on-autosuggest-select="_validateDestinations" on-blur="_validateDestinations" error-message="You missed this." invalid-error-message="Destination is same as Origin"></t-autosuggest>
                    </div>
                </div>
                <div class="horizontal flex layout  grouped">
                    <div class="fieldset flex" data-category="formComponents">
                        <t-calendar id="leg1Date" required selected-date="{{leg1Date}}" label="Departing" name="leg1Date" format="mm/dd/yyyy" submit-format="mm/dd/yyyy" error-message="You missed this."></t-calendar>
                    </div>
                    <div class="flex fieldset " data-category="formComponents" hidden$="{{_isRoundTrip}}">
                        <t-calendar id="leg2Date" required$="{{!_isRoundTrip}}" selected-date="{{leg2Date}}" label="Returning" name="leg2Date" format="mm/dd/yyyy" submit-format="mm/dd/yyyy" error-message="You missed this."></t-calendar>
                    </div>
                </div>
                <div class="horizontal flex layout " style="position: relative;margin-top: 5px;">
                    <div class="fieldset flex" data-category="formComponents">
                        <t-stepper min="1" max="9" plural-label="Adults" singular-label="Adult" secondary-label="(12+ years)" count="{{adultCount}}" name="adultCount" on-count-changed="_changeMaxCount" id="adultCount"></t-stepper>
                    </div>
                </div>
                <div class="horizontal flex layout ">
                    <div class="flex fieldset " data-category="formComponents">
                        <t-stepper min="0" max$="0" secondary-label="(0-11 years)" plural-label="Children" singular-label="Child" count="{{childCount}}" name="childCount" id="childCount" on-count-changed="_changeMaxCount"></t-stepper>
                    </div>
                </div>
                <div class="horizontal flex layout ">
                    <div class="flex fieldset " data-category="formComponents">
                        <t-stepper min="0" max$="0" secondary-label="(<2 years, in lap)" plural-label="Infants" singular-label="Infant" count="{{infantCount}}" name="infantCount" id="infantCount"></t-stepper>
                    </div>
                </div>
                <div class="horizontal flex layout ">
                    <div class="flex fieldset " data-category="formComponents">
                        <t-radio-group id="cabinType" pill-button name="cabinType" selected-item="{{cabinType}}" data='["Economy","Business","First"]' class="flightClass">
                        </t-radio-group>
                    </div>
                </div>
            </div>
        </t-form>
    </template>
</dom-module>
<script>
Polymer({
    is: 't-air-search',


     /**
     * Fired when user clicks on search button or 'search' API is called. 
     * @event t-air-search
     * @param {Object} SearchCriteria Check above criteria model for reference
     */
           

    properties: {
        /**
         * Leg 1 origin location, should be t-autosuggest selected item ie autosuggest api response
         */
        leg1Origin: {
            type: Object,
            notify: true
        },

        /**
         * Leg 1 destination location, should be t-autosuggest selected item ie autosuggest api 
         * response
         */
        leg1Destination: {
            type: Object,
            notify: true
        },

        /**
         * Leg 1 origin location start date
         */        
        leg1Date: {
            type: String,
            notify: true,
            observer: '_updateLeg2Date'
        },

        /**
         * Leg 1 origin location start date
         */        
        leg2Date: {
            type: String,
            notify: true,
            observer: '_updateLeg1Date'
        },

        /**
         * Number of adult passengers.
         */
        adultCount: {
            type: Number,
            value: 1,
            notify: true,
        },

        /**
         * Number of child passengers.
         */
        childCount: {
            type: Number,
            value: 0,
            notify: true,
        },

        /**
         * Number of infant passengers.
         */
        infantCount: {
            type: Number,
            value: 0,
            notify: true,
        },

        /**
         * Used to set leg1Date datepicker min value on page load (current date + minStartDate)                 
         */
        minStartDate:{
            type: Number,
            value: 0,
            notify: true
        },

        /**
         * The type of trip, possible values are _Round Trip_ and _One Way_
         */
        tripType: {
            type: String,
            value: 'RoundTrip',
            notify: true,
            observer: '_tripTypeChanged'
        },

        /**
         * The type of cabin, possible values are Economy/Business/First
         */
        cabinType: {
            type: String,
            value: "Economy"
        },



        /**
         * The api url that returns suggestions (auto suggest) shown in
         * departure and arrival airport fields
         */
        suggestionUrl: String,

        /**
         * Controls how the search happens, if the value of this is set to
         * 'event' then it raises a event which can be handled by the consumer
         * of this component to do search. In another case if the value is
         * set to `url` then search will be done by opening the deep link
         * url.
         */
        isDeeplink: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
        },        

        /**
         * Check if the trip type is _Round Trip_
         */
        _isRoundTrip: {
            type: Boolean,
            computed: '_tripTypeChanged(tripType)'
        },

        /**
         * The query parameter for autosuggest to work. This is token to pass with the request for * autosuggest.
         */
        queryParams: {
            type: String,
            value: ""
        },

        /**
         * Name of the event to subscribe to and trigger API call. By defaults it subscribes to
         * Mystique seach api.
         */
        eventName:{
            type: String,
            value: 't-air-search'
        },
    },

    attached: function() {
        var component = this;
        this.async(function() {
            // access sibling or parent elements here
            var startDate = new Date();
            startDate.setDate(startDate.getDate() + this.minStartDate);
            this.$.leg1Date.picker.set('min', startDate);
        });

        //api event event registration
        this.addEventListener(this.eventName+'-api-success', this.onSearchSuccess);
        this.addEventListener(this.eventName+'-api-error', this.onSearchFailure);

    },

    _tripTypeChanged: function(tripType) {
        if (this.tripType !== undefined) {
            if (this.tripType === 'RoundTrip') {
                this._updateLeg2Date();
                return false;
            } else {
                if (this.$.leg1Date.picker !== undefined)
                    this.$.leg1Date.picker.set('max', false);
            }
        }
        return true;
    },

    _updateLeg2Date: function(newValue, oldValue) {
        //handle page load case as picker will be ready to access
        if(!newValue && !oldValue)
            return;

        if (this.tripType !== undefined) {
            if (this.tripType === 'RoundTrip') {
                if (this.leg1Date != '') {
                    this.$.leg2Date.picker.set('min', new Date(this.leg1Date));
                }
            } else {
                this.$.leg1Date.picker.set('max', false);
            }
        }
    },

    _updateLeg1Date: function() {
        if (this.tripType === 'RoundTrip') {
            if (this.leg2Date != '') {
                this.$.leg1Date.picker.set('max', new Date(this.leg2Date));
            }
        }
    },

    _getDeeplinkUrl: function() {

        var deeplink = '';

        if (this.tripType == 'RoundTrip')
            deeplink = deeplink + "triptype=RoundTrip&";
        else
            deeplink = deeplink + "triptype=OneWay&";

        deeplink = deeplink + "adultCounts=" + this.adultCounts + "&childCountren=" + this.childCountren + "&seniors=0&infantCounts=" + this.infantCount + "&nonstoponly=false&cabinclass=NoPreference&deploc1=" + this.$.leg1Origin.selectedItem.code + "&arrloc1=" + this.$.leg1Destination.selectedItem.code + "&depdate1=" + this.leg1Date + "&inda1=false&inaa1=false";

        if (this.tripType == 'RoundTrip')
            deeplink = deeplink + "&deploc2=" + this.$.leg1Destination.selectedItem.code + "&arrloc2=" + this.$.leg1Origin.selectedItem.code + "&depdate2=" + this.leg2Date + "&inda2=false&inaa2=false";

        deeplink = deeplink + "&dateFormat=MM/dd/yyyy&culture=en-US&currency=USD&cid=mystiquedemo&update=true";

        return deeplink;
    },

    _validateDestinations: function(event) {
        if (this.$.leg1Origin.selectedItem != null && this.$.leg1Destination.selectedItem != null) {
            if (this.$.leg1Origin.selectedItem.code == this.$.leg1Destination.selectedItem.code) {
                this.$.leg1Destination.isInvalid = true;
                this.$.leg1Destination.validate();
                return false;
            }
        }
        return true;
    },

    _changeMaxCount: function() {
        this.$.adultCount.max = 9 - this.$.childCount.count;
        this.$.childCount.max = 9 - this.$.adultCount.count;
        this.$.infantCount.max = this.$.adultCount.count;
    },

    _onSearch: function(event) {
        if(!this._validateDestinations()){
            return;
        }

        if (this.isDeeplink) {
            this.fire(this.eventName, this._getDeeplinkUrl());
        } else {
            var btnSubmit = this.querySelector("#submit");
            btnSubmit.disabled = true;
            btnSubmit.label = "Searching Flights...";
            this.fire(this.eventName, event.detail);
        }
    },

    /**
     * The method to fire the search function
     */
    search: function() {
        this.$.searchForm.submit();
    },    

    /**
     * Event listener for successful t-air-search-api call
     * Handler for t-air-search-api-success event
     */
    onSearchSuccess: function(event) {
        //not used
    },

    /**
     * Event listener for failed t-air-search-api call
     * Handler for t-air-search-api-error event
     */
    onSearchFailure: function(event) {
        var btnSubmit = this.querySelector("#submit");
        btnSubmit.disabled = false;
        btnSubmit.label = "Search Flights";
    }
})
</script>
