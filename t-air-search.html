<link rel='import' href='../polymer/polymer.html'>
<link rel='import' href='../t-form/t-form.html'>
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html" />
<!--
This component is a form that allows a user to search for flights.
It exposes certain prperties which allow control over different aspects
of searching.

There are fundamentally three types of properties that form the public
api of this component.

__User input__: Properties like `DepartureAirport`, `adult` etc. reflect the user input
necessary for searching

__Validation__: Properties like `maxChildren` reflect the validation limits imposed
on user input

__For component consumers__: Properties like `searchType` allow the consumer
of this component to control the behaviour of this component.

-->
<dom-module id='t-air-search'>
    <template>
        <style include="iron-flex">
        :host {
            display: block;
            padding: 0 10px 5px;
        }
        
        t-form {
            padding: 0;
            margin: 0;
            max-width: 100%;
        }
        
        [pill-button] ::content iron-selector {
            width: 100%;
            text-align: center;
        }
        
        ::content t-radio-button {
            -ms-flex: 1;
            -webkit-flex: 1;
            flex: 1;
        }
        
        t-autosuggest,
        t-calendar,
        t-stepper {
            outline: 0;
        }
        </style>
        <t-form show-loader error-block class="canvas vertical layout flex" name="untitled-form" heading="Untitled Form" action-button="Full" submit-button-label="Search Flights" secondary-action-label="Cancel" label-position="Top">
            <div class="form flex ">
                <div class="horizontal flex layout " style="position: relative;">
                    <div class="flex fieldset " data-category="formComponents">
                        <t-radio-group id="itineraryType" name="itineraryType" data='["RoundTrip","OneWay"]' pill-button selected-item="{{itineraryType}}">
                        </t-radio-group>
                    </div>
                </div>
                <div class="horizontal flex layout  grouped" style="position: relative;">
                    <div class="flex fieldset " data-category="formComponents">
                        <t-autosuggest id="DepartureAirport" name="DepartureAirport" required selected-value="{{DepartureAirport}}" query-params="{{queryParams}}" sub-type="airport" class="center-justified" label="Origin" token-param="formattedAddress" data-url="{{suggestionUrl}}" on-autosuggest-select="_validateDestinations" on-blur="_validateDestinations" error-message="You missed this."></t-autosuggest>
                    </div>
                </div>
                <div class="horizontal flex layout  grouped" style="position: relative;">
                    <div class="flex fieldset " data-category="formComponents">
                        <t-autosuggest id="ArrivalAirport" name="ArrivalAirport" selected-value="{{ArrivalAirport}}" query-params="{{queryParams}}" sub-type="airport" required label="Destination" token-param="formattedAddress" data-url="{{suggestionUrl}}" on-autosuggest-select="_validateDestinations" on-blur="_validateDestinations" error-message="You missed this." invalid-error-message="Destination is same as Origin"></t-autosuggest>
                    </div>
                </div>
                <div class="horizontal flex layout  grouped">
                    <div class="fieldset flex" data-category="formComponents">
                        <t-calendar id="departureDate" required selected-date="{{DepartureDate}}" label="Departing" name="departureDate" format="mm/dd/yyyy" submit-format="mm/dd/yyyy" error-message="You missed this."></t-calendar>
                    </div>
                    <div class="flex fieldset " data-category="formComponents" hidden$="{{_isRoundTrip}}">
                        <t-calendar id="arrivalDate" required$="{{!_isRoundTrip}}" selected-date="{{ArrivalDate}}" label="Returning" name="arrivalDate" format="mm/dd/yyyy" submit-format="mm/dd/yyyy" error-message="You missed this."></t-calendar>
                    </div>
                </div>
                <div class="horizontal flex layout " style="position: relative;margin-top: 5px;">
                    <div class="fieldset flex" data-category="formComponents">
                        <t-stepper min="1" max="9" plural-label="Adults" singular-label="Adult" secondary-label="(12+ years)" count="{{adult}}" name="adult" on-count-changed="changeMaxCount" id="adult"></t-stepper>
                    </div>
                </div>
                <div class="horizontal flex layout ">
                    <div class="flex fieldset " data-category="formComponents">
                        <t-stepper min="0" max$="{{_maxChildren}}" secondary-label="(0-11 years)" plural-label="Children" singular-label="Child" count="{{child}}" name="child" id="child" on-count-changed="changeMaxCount"></t-stepper>
                    </div>
                </div>
                <div class="horizontal flex layout ">
                    <div class="flex fieldset " data-category="formComponents">
                        <t-stepper min="0" max$="{{_maxInfants}}" secondary-label="(<2 years, in lap)" plural-label="Infants" singular-label="Infant" count="{{infant}}" name="infant" id="infant"></t-stepper>
                    </div>
                </div>
                <div class="horizontal flex layout ">
                    <div class="flex fieldset " data-category="formComponents">
                        <t-radio-group id="cabinType" pill-button name="cabinType" selected-item="{{cabinType}}" data='["Economy","Business","First"]' class="flightClass">
                        </t-radio-group>
                    </div>
                </div>
            </div>
        </t-form>
    </template>
</dom-module>
<script>
Polymer({
    is: 't-air-search',
    properties: {

        /**
         * The location to search from.
         * Must be a value picked from suggested locations?.
         */
        DepartureAirport: String,

        /**
         * The location of arrival.
         * Must be a value picked from suggested locations?.
         */
        ArrivalAirport: {
            type:String,
            observer:'_validateDestinations'
        },
        /**
         * The date of departure.
         */
        DepartureDate: {
            type: String,
            value: '',
            notify: true,
            observer: '_travelDateChanged'
        },

        /**
         * The date of returning back to the departure location
         * __if__ the type of trip is _Round Trip_
         */
        ArrivalDate: {
            type: String,
            value: '',
            notify: true,
            observer: '_returnDateChanged'
        },

        /**
         * The value of adults selected.
         */
        adult: {
            type: Number,
            value: 1
        },

        /**
         * The value of children selected.
         */
        child: {
            type: Number,
            value: 0
        },

        /**
         * The value of infants selected.
         */
        infant: {
            type: Number,
            value: 0
        },

        /**
         * The maximum number of children allowed for travel
         */
        _maxChildren: {
            type: Number,
            notify: true,
            value: 6
        },

        /**
         * The maximum number of infants allowed for travel
         */
        _maxInfants: {
            type: Number,
            notify: true,
            value: 1
        },

        /**
         * The api url that returns suggestions (auto suggest) shown in
         * departure and arrival airport fields
         */
        suggestionUrl: String,

        /**
         * The error message that will be shown to the user
         */
        error: {
            type: String,
            value: ''
        },

        /**
         * The type of trip, possible values are _Round Trip_ and _One Way_
         */
        itineraryType: {
            type: String,
            value: 'RoundTrip',
            reflectToAttribute: true,
            notify: true,
            observer: '_tripTypeChanged'
        },

        /**
         * Controls how the search happens, if the value of this is set to
         * 'event' then it raises a event which can be handled by the consumer
         * of this component to do search. In another case if the value is
         * set to `url` then search will be done by opening the deep link
         * url.
         */
        searchType: {
            type: String,
            value: 'event',
            reflectToAttribute: true
        },

        /**
         * Check if the type of trip is _Round Trip_
         */
        _isRoundTrip: {
            type: Boolean,
            computed: '_tripTypeChanged(itineraryType)'
        },

        /**
         * The url that will used for searching if `searchType` is set to `url`.
         * The initial * value should be set to the search api url, this initial
         * value be used to construct the deep link url by appending
         * query parameters to it.
         */
        deeplinkUrl: {
            type: String,
            value: '',
            reflectToAttribute: true
        },

        /**
         * The query parameter for autosuggest to work. This is token to pass with the request for * autosuggest.
         */
        queryParams: {
            type: String,
            value: ""
        },

        /**
         * The type of cabin, example values are _Economy_ and _Business_
         */
        cabinType: {
            type: String,
            value: "Economy"
        },

    },

    attached: function() {
        var component = this;
        this.async(function() {
            // access sibling or parent elements here
            var startDate = new Date();
            startDate.setDate(startDate.getDate() + 3);
            this.$.departureDate.picker.set('min', startDate);
        });
        this.addEventListener('on-form-submit', function(event) {
            component.search(event.detail);
        });
    },

    _tripTypeChanged: function (tripType) {
        if (this.itineraryType !== undefined) {
            if (this.itineraryType === 'RoundTrip') {
                this._travelDateChanged();
                return false;
            }
            else {
                if(this.$.departureDate.picker !== undefined)
                    this.$.departureDate.picker.set('max', false);
            }
        }
        return true;
    },

    _travelDateChanged: function() {
        if (this.itineraryType !== undefined) {
            if (this.itineraryType === 'RoundTrip') {
                if (this.DepartureDate != '') {
                    this.$.arrivalDate.picker.set('min', new Date(this.DepartureDate));
                }
            } else {

                this.$.departureDate.picker.set('max', false);
            }
        }
    },

    _returnDateChanged: function() {
        if (this.itineraryType === 'RoundTrip') {
            if (this.ArrivalDate != '') {
                this.$.departureDate.picker.set('max', new Date(this.ArrivalDate));
            }
        }
    },

    _getDateArray: function(dateString) {
        var date = new Date(dateString);
        return [date.getFullYear, date.getMonth(), date.getDate()];
    },

    _getDeeplinkUrl: function() {

        var deeplink = this.deeplinkUrl;

        if (this.itineraryType == 'RoundTrip')
            deeplink = deeplink + "triptype=RoundTrip&";
        else
            deeplink = deeplink + "triptype=OneWay&";

        deeplink = deeplink + "adults=" + this.adults + "&children=" + this.children + "&seniors=0&infants=" + this.infant + "&nonstoponly=false&cabinclass=NoPreference&deploc1=" + this.$.DepartureAirport.selectedItem.code + "&arrloc1=" + this.$.ArrivalAirport.selectedItem.code + "&depdate1=" + this.DepartureDate + "&inda1=false&inaa1=false";

        if (this.itineraryType == 'RoundTrip')
            deeplink = deeplink + "&deploc2=" + this.$.ArrivalAirport.selectedItem.code + "&arrloc2=" + this.$.DepartureAirport.selectedItem.code + "&depdate2=" + this.ArrivalDate + "&inda2=false&inaa2=false";

        deeplink = deeplink + "&dateFormat=MM/dd/yyyy&culture=en-US&currency=USD&cid=mystiquedemo&update=true";

        return deeplink;
    },

    _validateDestinations: function(event) {
        if (this.$.DepartureAirport.selectedItem != null && this.$.ArrivalAirport.selectedItem != null) {
            if (this.$.DepartureAirport.selectedItem.code == this.$.ArrivalAirport.selectedItem.code) {
                this.$.ArrivalAirport.isInvalid = true;
                this.$.ArrivalAirport.validate();
            }
        }
    },

    changeMaxCount: function() {
        this.$.adult.max = 9 - this.$.child.count;
        this.$.child.max = 9 - this.$.adult.count;
        this.$.infant.max = this.$.adult.count;
    },


    /**
     * The method to fire the search function
     */
    search: function(searchParams) {
        if (this.searchType == 'url') {
            var win = window.open(this._getDeeplinkUrl(), '_blank');
            win.focus();
        } else {
            var btnSubmit = this.querySelector("#submit");
            btnSubmit.disabled = true;
            btnSubmit.label = "Searching Flights...";
            this.fire('on-search', searchParams);
        }
    }
})
</script>
